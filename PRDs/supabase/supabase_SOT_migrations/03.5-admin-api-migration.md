# Admin API Migration

## Overview

| Field | Value |
|-------|-------|
| **Phase** | Sprint 2-3 (Day 3-7) |
| **Prerequisites** | Schema migration, RPC functions deployed |
| **Related Docs** | [03-backend-api-migration.md](./03-backend-api-migration.md), [04-cron-batch-sync.md](./04-cron-batch-sync.md) |

---

## Current State Analysis

The admin API already has a **two-tier architecture** in place:
- HubSpot as the single source of truth for writes
- Supabase as the read-optimized secondary database
- Redis for real-time counter management
- Fire-and-forget pattern for Supabase syncs

This PRD documents the minimal changes needed to align with the Supabase-first architecture.

---

## Endpoint Categories

### Category 1: NO CHANGE REQUIRED

These endpoints already follow optimal patterns:

| Endpoint | File | Current Pattern | Reason No Change |
|----------|------|-----------------|------------------|
| List Mock Exams | `admin/mock-exams/list.js` | Cache → Supabase → HubSpot fallback | Already Supabase-first read |
| Mock Exams Aggregates | `admin/mock-exams/aggregates.js` | Cache → Supabase → HubSpot fallback | Already Supabase-first read |
| Trainee Bookings | `admin/trainees/[contactId]/bookings.js` | Cache → Supabase → HubSpot fallback | Already Supabase-first read |
| Create Mock Exam | `admin/mock-exams/create.js` | HubSpot write → Supabase sync | Exams are admin-created, HubSpot-first is correct |
| Bulk Create Mock Exams | `admin/mock-exams/bulk-create.js` | HubSpot batch → Supabase sync | Exams are admin-created, HubSpot-first is correct |
| Update Mock Exam | `admin/mock-exams/update.js` | HubSpot write → Supabase sync | Exams are admin-created, HubSpot-first is correct |
| Bulk Update Mock Exams | `admin/mock-exams/bulk-update.js` | HubSpot batch → Supabase sync | Exams are admin-created, HubSpot-first is correct |
| Delete Mock Exam | `admin/mock-exams/delete.js` | HubSpot delete → Supabase delete | Proper ordering |
| Batch Delete Mock Exams | `admin/mock-exams/batch-delete.js` | HubSpot delete → Supabase delete (with FK ordering) | Handles FK constraints |
| Clone Mock Exams | `admin/mock-exams/clone.js` | HubSpot batch → Supabase sync | Exams are admin-created |
| Update Trainee Tokens | `admin/trainees/[contactId]/tokens.js` | HubSpot write → Supabase sync | Admin credit adjustments are HubSpot-first |
| Cron Sync | `admin/cron/sync-supabase.js` | HubSpot → Supabase reconciliation | Keeps existing pattern |
| Force Sync | `admin/sync/force-supabase.js` | Manual HubSpot → Supabase | Recovery mechanism |

**Key Insight**: Mock exams are admin-created objects that originate in HubSpot. They should remain HubSpot-first for writes since admins manage them through HubSpot directly.

---

### Category 2: MINOR UPDATES REQUIRED

These endpoints need updates to use cascading lookup or improved Supabase sync:

#### 2.1 Batch Cancel Bookings

**File**: `admin_root/api/bookings/batch-cancel.js`

| Change | Current | New |
|--------|---------|-----|
| Booking lookup | HubSpot ID only | Cascading lookup (hubspot_id → id → booking_id) |
| Credit restore | HubSpot → Supabase sync | Can use `cancel_booking_atomic` RPC for Supabase-first cancellations |

**Decision**: Keep HubSpot-first for admin batch operations. Supabase RPC is for user-initiated cancellations.

```javascript
// Current pattern - KEEP AS-IS for admin operations
// 1. Cancel in HubSpot (batch)
// 2. Restore credits in HubSpot
// 3. Sync to Supabase (fire-and-forget)
```

**NO CODE CHANGES REQUIRED** - Admin batch operations should remain HubSpot-first.

---

#### 2.2 Cancel Bookings for Exam

**File**: `admin_root/api/admin/mock-exams/[id]/cancel-bookings.js`

| Change | Current | New |
|--------|---------|-----|
| Booking status sync | Only updates `is_active` in Supabase | Ensure full booking sync |

**Update Required**: Ensure `updateBookingStatusInSupabase()` syncs all relevant fields.

```javascript
// Verify this function exists and syncs complete booking data
async function updateBookingStatusInSupabase(bookingIds, newStatus) {
  // Should update: is_active, updated_at, synced_at
  // NOT just is_active
}
```

---

#### 2.3 Admin Create Booking

**File**: `admin_root/api/admin/bookings/create.js`

| Change | Current | New |
|--------|---------|-----|
| Booking creation | HubSpot-first → Supabase sync | **OPTION A**: Keep HubSpot-first (admin operations) |
| | | **OPTION B**: Use Supabase-first like user bookings |

**Decision**: **OPTION A - Keep HubSpot-first for admin bookings**

**Rationale**:
- Admin bookings are often manual overrides or corrections
- Admin has direct access to HubSpot for troubleshooting
- Consistency with other admin mock exam operations
- User-facing `create.js` in user_root will use Supabase-first

**NO CODE CHANGES REQUIRED** - Admin booking creation stays HubSpot-first.

---

### Category 3: REQUIRES REVIEW

These endpoints need verification but likely no changes:

| Endpoint | File | Status | Action |
|----------|------|--------|--------|
| Get Mock Exam | `admin/mock-exams/get.js` | Likely HubSpot-first | Verify Supabase fallback exists |
| Mock Exam Metrics | `admin/mock-exams/metrics.js` | Unknown | Review for Supabase-first read |
| Scheduled Activation | `admin/cron/activate-scheduled-exams.js` | Unknown | Ensure Supabase sync after activation |
| Exam Bookings List | `admin/mock-exams/[id]/bookings.js` | Unknown | Verify Supabase-first read |
| Attendance Update | `admin/mock-exams/[id]/attendance.js` | Unknown | Verify Supabase sync |

---

## Refund Service Update

**File**: `admin_root/api/_shared/refund.js`

This is the critical file for token refunds. It needs to support cascading booking lookup.

### Current Implementation

```javascript
// Current: Looks up by hubspot_id only
async function refundToken(bookingHubspotId, adminEmail, tokenType) {
  const booking = await getBookingFromHubSpot(bookingHubspotId);
  // ... refund logic
}
```

### Updated Implementation

```javascript
const { getBookingCascading, getContactByStudentIdFromSupabase } = require('./supabase-data');
const { supabaseAdmin } = require('./supabase');

/**
 * Refund token for a booking
 * Supports cascading lookup: hubspot_id → id (UUID) → booking_id
 *
 * @param {string} identifier - Booking identifier (any of the 3 types)
 * @param {string} adminEmail - Admin performing the refund
 * @param {string} tokenType - Credit field to restore
 */
async function refundToken(identifier, adminEmail, tokenType) {
  console.log('[REFUND] Starting refund:', { identifier, adminEmail, tokenType });

  // Cascading lookup from Supabase
  const booking = await getBookingCascading(identifier);

  if (!booking) {
    throw new Error(`Booking not found: ${identifier}`);
  }

  if (booking.is_active === 'Cancelled') {
    throw new Error('Booking is already cancelled');
  }

  if (booking.token_refunded_at) {
    throw new Error('Token already refunded');
  }

  // Get contact credits using existing function
  const contact = await getContactByStudentIdFromSupabase(booking.student_id);
  if (!contact) {
    throw new Error('Contact not found for booking');
  }

  // Calculate restored credit value
  const currentCredits = contact[tokenType] || 0;
  const restoredCredits = currentCredits + 1;

  // Update Supabase atomically
  const { error: bookingError } = await supabase
    .from('hubspot_bookings')
    .update({
      token_refunded_at: new Date().toISOString(),
      token_refund_admin: adminEmail,
      updated_at: new Date().toISOString(),
      synced_at: new Date().toISOString()
    })
    .eq('id', booking.id);

  if (bookingError) {
    throw new Error(`Failed to update booking: ${bookingError.message}`);
  }

  // Restore credits in Supabase
  const { error: creditError } = await supabase
    .from('hubspot_contact_credits')
    .update({
      [tokenType]: restoredCredits,
      updated_at: new Date().toISOString(),
      synced_at: new Date().toISOString()
    })
    .eq('id', contact.id);

  if (creditError) {
    throw new Error(`Failed to restore credits: ${creditError.message}`);
  }

  // Sync to HubSpot (fire-and-forget for batch cron)
  // Or sync immediately for admin operations
  try {
    await syncRefundToHubSpot(booking, contact, tokenType, adminEmail, restoredCredits);
  } catch (hubspotError) {
    console.error('[REFUND] HubSpot sync failed (will retry in batch):', hubspotError.message);
    // Don't throw - Supabase is source of truth, HubSpot will sync via cron
  }

  console.log('[REFUND] Completed:', {
    bookingId: booking.booking_id,
    tokenType,
    restoredCredits
  });

  return {
    success: true,
    booking_id: booking.booking_id,
    id: booking.id,
    hubspot_id: booking.hubspot_id,
    credits_restored: restoredCredits
  };
}

/**
 * Sync refund to HubSpot (non-blocking)
 */
async function syncRefundToHubSpot(booking, contact, tokenType, adminEmail, newCreditValue) {
  // Only sync if hubspot_id exists
  if (booking.hubspot_id) {
    await hubspotClient.crm.objects.basicApi.update(
      BOOKING_OBJECT_ID,
      booking.hubspot_id,
      {
        properties: {
          token_refunded_at: new Date().getTime().toString(),
          token_refund_admin: adminEmail
        }
      }
    );
  }

  if (contact.hubspot_id) {
    await hubspotClient.crm.contacts.basicApi.update(
      contact.hubspot_id,
      {
        properties: {
          [tokenType]: newCreditValue.toString()
        }
      }
    );
  }
}

module.exports = { refundToken };
```

---

## Extend Existing supabase-data.js

Add the `getBookingCascading()` function to the existing `admin_root/api/_shared/supabase-data.js` file.

### Function to Add

```javascript
// ============== CASCADING BOOKING LOOKUP ==============

/**
 * Get booking with cascading lookup
 * Priority: hubspot_id → id (UUID) → booking_id
 *
 * @param {string} identifier - The booking identifier (could be any of the 3 types)
 * @returns {Promise<Object|null>} Booking record or null
 */
async function getBookingCascading(identifier) {
  if (!identifier) return null;

  console.log('[SUPABASE] Cascading booking lookup:', { identifier });

  const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(identifier);
  const isBookingId = /^BK-/.test(identifier) || /^Mock Discussion-/.test(identifier);
  const isHubSpotId = /^\d+$/.test(identifier);

  // Priority 1: Try as hubspot_id
  if (isHubSpotId) {
    const { data, error } = await supabaseAdmin
      .from('hubspot_bookings')
      .select('*')
      .eq('hubspot_id', identifier)
      .single();

    if (!error && data) {
      console.log('[SUPABASE] Found by hubspot_id:', identifier);
      return data;
    }
  }

  // Priority 2: Try as id (UUID)
  if (isUUID) {
    const { data, error } = await supabaseAdmin
      .from('hubspot_bookings')
      .select('*')
      .eq('id', identifier)
      .single();

    if (!error && data) {
      console.log('[SUPABASE] Found by id (UUID):', identifier);
      return data;
    }
  }

  // Priority 3: Try as booking_id
  if (isBookingId) {
    const { data, error } = await supabaseAdmin
      .from('hubspot_bookings')
      .select('*')
      .eq('booking_id', identifier)
      .single();

    if (!error && data) {
      console.log('[SUPABASE] Found by booking_id:', identifier);
      return data;
    }
  }

  console.warn('[SUPABASE] Booking not found with identifier:', identifier);
  return null;
}

// Add to existing module.exports:
//   getBookingCascading
```

**Note**: The `getContactCreditsFromSupabase()` function already exists in admin_root's supabase-data.js (as `getContactByStudentIdFromSupabase` and `getContactByEmailFromSupabase`). Use the existing functions.

---

## Admin-Specific Considerations

### 1. Audit Trail

Admin operations should still create HubSpot timeline notes for audit purposes:

```javascript
// After Supabase write, create audit note (fire-and-forget)
createAuditNote(bookingHubspotId, {
  action: 'REFUND',
  admin: adminEmail,
  tokenType,
  timestamp: new Date().toISOString()
}).catch(err => console.error('[AUDIT] Failed to create note:', err.message));
```

### 2. Batch Operations

For admin batch operations (bulk update, batch cancel, etc.), continue using HubSpot batch APIs:

```javascript
// Admin batch operations pattern
// 1. Execute batch in HubSpot (source of truth for admin ops)
// 2. Sync results to Supabase (fire-and-forget)
// 3. Batch cron will reconcile any drift

const hubspotResults = await hubspotBatchUpdate(items);
await Promise.allSettled(
  hubspotResults.map(item => syncToSupabase(item))
);
```

### 3. Error Recovery

If Supabase sync fails for admin operations:
- Log the failure
- Continue with operation (HubSpot is source of truth for admin)
- Batch cron will reconcile within 2 hours

---

## Data Flow Diagram

```
┌────────────────────────────────────────────────────────────────────────────┐
│                     ADMIN OPERATIONS DATA FLOW                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  MOCK EXAM OPERATIONS (Create/Update/Delete)                               │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                │
│                                                                            │
│  Admin Action → HubSpot (source of truth) → Supabase Sync (fire-and-forget)│
│                                                                            │
│  Rationale: Exams are admin-managed, HubSpot is the primary interface     │
│                                                                            │
│  ══════════════════════════════════════════════════════════════════════   │
│                                                                            │
│  REFUND OPERATIONS                                                         │
│  ━━━━━━━━━━━━━━━━━                                                         │
│                                                                            │
│  Admin Action → Supabase Lookup (cascading) → Supabase Update              │
│                                            → HubSpot Sync (fire-and-forget)│
│                                                                            │
│  Rationale: Refunds affect credits which are now Supabase-first           │
│                                                                            │
│  ══════════════════════════════════════════════════════════════════════   │
│                                                                            │
│  BATCH CANCEL OPERATIONS                                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━                                                   │
│                                                                            │
│  Admin Action → HubSpot Batch Update → Supabase Sync (fire-and-forget)    │
│                                                                            │
│  Rationale: Batch operations use HubSpot batch API for efficiency         │
│                                                                            │
│  ══════════════════════════════════════════════════════════════════════   │
│                                                                            │
│  READ OPERATIONS (List, Get, Aggregates)                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                   │
│                                                                            │
│  Admin Request → Redis Cache → Supabase → HubSpot Fallback + Auto-Sync    │
│                                                                            │
│  Rationale: Already Supabase-first for reads                              │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## Sprint 2-3 Checklist (Admin)

### Sprint 2: Read Migration
- [ ] Verify `admin/mock-exams/get.js` uses Supabase-first read
- [ ] Verify `admin/mock-exams/[id]/bookings.js` uses Supabase-first read
- [ ] Verify `admin/mock-exams/metrics.js` uses Supabase-first read
- [ ] Add `getBookingCascading()` to admin_root `supabase-data.js`
- [ ] Test cascading lookup in refund service

### Sprint 3: Write Migration
- [ ] Update `refund.js` to use Supabase-first with HubSpot sync
- [ ] Verify `cancel-bookings.js` syncs complete booking data to Supabase
- [ ] Verify `attendance.js` syncs attendance updates to Supabase
- [ ] Verify `activate-scheduled-exams.js` syncs activation to Supabase
- [ ] Test refund with all ID types (hubspot_id, UUID, booking_id)
- [ ] Deploy and monitor for errors

---

## Summary

| Operation Type | Data Flow | Rationale |
|----------------|-----------|-----------|
| Mock Exam CRUD | HubSpot-first → Supabase sync | Admin-managed, HubSpot UI |
| Refund | Supabase-first → HubSpot sync | Credit operations are Supabase-first |
| Batch Cancel | HubSpot-first → Supabase sync | Uses HubSpot batch API |
| List/Read | Supabase-first → HubSpot fallback | Already optimized |
| Token Adjustment | HubSpot-first → Supabase sync | Admin override, HubSpot UI |

---

*Previous: [03-backend-api-migration.md](./03-backend-api-migration.md)*
*Next: [04-cron-batch-sync.md](./04-cron-batch-sync.md)*
