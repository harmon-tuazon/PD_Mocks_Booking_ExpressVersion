# Testing Strategy & Rollback Plan

## Overview

| Field | Value |
|-------|-------|
| **Phase** | All Sprints |
| **Prerequisites** | None |
| **Related Docs** | All other migration documents |

---

## Testing Strategy

### Test Scenarios

#### Scenario 1: New Booking (No HubSpot ID Yet)

```javascript
describe('Supabase-First Booking Creation', () => {
  it('should create booking with NULL hubspot_id', async () => {
    const response = await createBooking(validData);

    expect(response.status).toBe(201);
    expect(response.data.booking_id).toBeDefined();
    expect(response.data.id).toBeDefined();  // Existing UUID column

    // Verify Supabase record
    const booking = await getBookingFromSupabase(response.data.id);
    expect(booking.hubspot_id).toBeNull();

    // Wait for batch sync (in production, this is 2 hours)
    // For testing, trigger manually
    await triggerBatchSync();

    // Verify HubSpot ID populated
    const updatedBooking = await getBookingFromSupabase(response.data.id);
    expect(updatedBooking.hubspot_id).toBeDefined();
    expect(updatedBooking.hubspot_last_sync_at).toBeDefined();
  });
});
```

#### Scenario 2: Contact Without HubSpot ID

```javascript
describe('New Contact Credit Operations', () => {
  it('should handle contact with NULL hubspot_id', async () => {
    // Create contact in Supabase only
    const contact = await createContactInSupabase({
      // id is auto-generated by gen_random_uuid()
      hubspot_id: null,  // Not synced yet
      student_id: 'TEST001',
      email: 'test@example.com',
      sj_credits: 5
    });

    // Credit validation should work
    const credits = await validateCredits('TEST001', 'test@example.com');
    expect(credits.sj_credits).toBe(5);

    // Booking should work (with NULL contact hubspot_id)
    const booking = await createBooking({
      studentId: 'TEST001',
      studentEmail: 'test@example.com',
      ...
    });
    expect(booking.success).toBe(true);
  });
});
```

#### Scenario 3: Idempotency Check

```javascript
describe('Idempotency via Supabase', () => {
  it('should return cached response for duplicate request', async () => {
    const bookingData = generateBookingData();

    // First request - creates booking
    const response1 = await createBooking(bookingData);
    expect(response1.status).toBe(201);

    // Second request - same idempotency key
    const response2 = await createBooking(bookingData);
    expect(response2.status).toBe(200);  // Cached response
    expect(response2.data.idempotent).toBe(true);

    // Verify only one booking created
    const bookings = await getBookingsByStudent(bookingData.studentId);
    expect(bookings.length).toBe(1);
  });
});
```

#### Scenario 4: Atomic Rollback

```javascript
describe('Atomic Transaction Rollback', () => {
  it('should rollback booking if credit update fails', async () => {
    // Setup: Create contact with 0 credits
    const contact = await createContactInSupabase({
      student_id: 'TEST002',
      email: 'test2@example.com',
      sj_credits: 0  // Cannot deduct
    });

    // Attempt booking
    const response = await createBooking({
      studentId: 'TEST002',
      studentEmail: 'test2@example.com',
      tokenUsed: 'sj_credits',  // Will fail - insufficient credits
      ...
    });

    expect(response.status).toBe(400);

    // Verify NO booking was created (rollback worked)
    const bookings = await getBookingsByStudent('TEST002');
    expect(bookings.length).toBe(0);
  });
});
```

#### Scenario 5: Booking Cancellation

```javascript
describe('Booking Cancellation', () => {
  it('should cancel booking and restore credits atomically', async () => {
    // Setup: Create contact and booking
    const contact = await createContactInSupabase({
      student_id: 'TEST003',
      email: 'test3@example.com',
      sj_credits: 5
    });

    const booking = await createBooking({
      studentId: 'TEST003',
      studentEmail: 'test3@example.com',
      tokenUsed: 'sj_credits',
      ...
    });

    // Credits should be 4 after booking
    let credits = await getContactCredits('TEST003', 'test3@example.com');
    expect(credits.sj_credits).toBe(4);

    // Cancel booking
    const cancelResponse = await cancelBooking(booking.data.id);
    expect(cancelResponse.status).toBe(200);

    // Credits should be 5 again
    credits = await getContactCredits('TEST003', 'test3@example.com');
    expect(credits.sj_credits).toBe(5);

    // Booking should be cancelled
    const cancelledBooking = await getBookingById(booking.data.id);
    expect(cancelledBooking.is_active).toBe('Cancelled');
  });
});
```

---

## Risk Assessment

### Risk Matrix

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Schema migration fails** | Low | Critical | Test in staging first, backup data |
| **Batch sync cron fails** | Low | Medium | Vercel monitoring, manual trigger available |
| **Supabase downtime** | Low | Critical | Health checks, graceful degradation |
| **HubSpot sync delay (2 hours)** | Expected | Low | Acceptable for audit purposes |
| **Frontend breaks on ID change** | Low | High | Feature flags, gradual rollout |
| **Data drift between systems** | Low | Medium | Batch sync overwrites HubSpot with Supabase data |

### Graceful Degradation

```javascript
// If Supabase is unavailable, temporarily fall back to HubSpot
async function getCreditsWithFallback(studentId, email) {
  try {
    return await getCreditsFromSupabase(studentId, email);
  } catch (error) {
    if (MIGRATION_FLAGS.HUBSPOT_SOURCE_OF_TRUTH) {
      console.warn('[FALLBACK] Supabase unavailable, using HubSpot');
      return await getCreditsFromHubSpot(studentId, email);
    }
    throw error;
  }
}
```

---

## Rollback Plan

### Rollback Triggers

| Trigger | Threshold | Action |
|---------|-----------|--------|
| Booking failure rate | >5% | Immediate rollback |
| HubSpot sync abandoned rate | >10% | Investigation + possible rollback |
| Data inconsistency | >1% | Investigation + reconciliation |
| Supabase unavailability | >5 minutes | Enable HubSpot fallback |

### Rollback Procedure

```bash
# 1. Set rollback feature flag
vercel env add FF_HUBSPOT_SOURCE_OF_TRUTH true --environment production

# 2. Disable Supabase-first writes
vercel env add FF_SUPABASE_PRIMARY_WRITE false --environment production

# 3. Deploy
vercel --prod

# 4. Run reconciliation (sync any pending Supabase records to HubSpot)
curl -X POST https://production.example.com/api/admin/cron/reconcile-hubspot \
  -H "Authorization: Bearer $CRON_SECRET"
```

### Rollback SQL (Schema)

If schema migration needs to be reverted:

```sql
-- WARNING: Only run if rollback is needed
-- First, sync all NULL hubspot_ids before running this

-- Revert hubspot_id to NOT NULL
ALTER TABLE hubspot_sync.hubspot_contact_credits
  ALTER COLUMN hubspot_id SET NOT NULL;

ALTER TABLE hubspot_sync.hubspot_bookings
  ALTER COLUMN hubspot_id SET NOT NULL;

-- Drop new columns
ALTER TABLE hubspot_sync.hubspot_contact_credits
  DROP COLUMN IF EXISTS hubspot_last_sync_at;

ALTER TABLE hubspot_sync.hubspot_bookings
  DROP COLUMN IF EXISTS hubspot_last_sync_at;

ALTER TABLE hubspot_sync.hubspot_mock_exams
  DROP COLUMN IF EXISTS hubspot_last_sync_at;

-- Drop audit table
DROP TABLE IF EXISTS hubspot_sync.supabase_audit_log;
```

---

## Success Metrics

### Key Performance Indicators

| KPI | Baseline | Target | Measurement |
|-----|----------|--------|-------------|
| **Booking Response Time (P95)** | 800ms | <200ms | Vercel Analytics |
| **Credit Validation Time (P95)** | 450ms | <100ms | API Logging |
| **Batch Sync Cron Success Rate** | N/A | >99% | Vercel cron logs |
| **Records Awaiting HubSpot ID** | N/A | <50 at any time | Monitoring query |
| **Concurrent User Capacity** | ~100 | 2,000+ | Load testing |
| **Data Consistency Rate** | 100% | 99.9% | Batch sync comparison |

### Monitoring Queries

```sql
-- Records awaiting HubSpot ID (batch sync targets)
SELECT
  'contact_credits' as table_name,
  COUNT(*) as total_records,
  COUNT(*) FILTER (WHERE hubspot_id IS NULL) as awaiting_hubspot_id,
  MAX(created_at) FILTER (WHERE hubspot_id IS NULL) as oldest_pending
FROM hubspot_sync.hubspot_contact_credits
UNION ALL
SELECT
  'bookings',
  COUNT(*),
  COUNT(*) FILTER (WHERE hubspot_id IS NULL),
  MAX(created_at) FILTER (WHERE hubspot_id IS NULL)
FROM hubspot_sync.hubspot_bookings;

-- Last sync timestamps (audit trail)
SELECT
  'contact_credits' as table_name,
  MAX(hubspot_last_sync_at) as last_sync,
  COUNT(*) FILTER (WHERE hubspot_last_sync_at > NOW() - INTERVAL '2 hours') as synced_recently
FROM hubspot_sync.hubspot_contact_credits
UNION ALL
SELECT
  'bookings',
  MAX(hubspot_last_sync_at),
  COUNT(*) FILTER (WHERE hubspot_last_sync_at > NOW() - INTERVAL '2 hours')
FROM hubspot_sync.hubspot_bookings
UNION ALL
SELECT
  'mock_exams',
  MAX(hubspot_last_sync_at),
  COUNT(*) FILTER (WHERE hubspot_last_sync_at > NOW() - INTERVAL '2 hours')
FROM hubspot_sync.hubspot_mock_exams;
```

---

## Pre-Deployment Checklist

### Sprint 1 (Schema Migration)
- [ ] Backup Supabase database
- [ ] Run schema migration in staging
- [ ] Verify all tests pass in staging
- [ ] Deploy schema migration to production
- [ ] Run verification queries
- [ ] Monitor for 24 hours

### Sprint 2 (Read Migration)
- [ ] Deploy backend changes with feature flag OFF
- [ ] Enable `SUPABASE_ONLY_READ=true`
- [ ] Monitor error rates for 2 hours
- [ ] If errors > 1%, rollback feature flag
- [ ] If stable, proceed to Sprint 3

### Sprint 3 (Write Migration)
- [ ] Deploy atomic transaction functions
- [ ] Enable `SUPABASE_PRIMARY_WRITE=true`
- [ ] Monitor booking creation success rate
- [ ] Verify credits are deducted correctly
- [ ] Test cancellation flow
- [ ] If errors > 1%, rollback feature flag

### Sprint 4 (Cron & Monitoring)
- [ ] Deploy batch sync cron
- [ ] Verify first cron run succeeds
- [ ] Monitor hubspot_id population rate
- [ ] Set up alerts for cron failures
- [ ] Create admin dashboard for sync audit

---

## Emergency Contacts

| Role | Responsibility |
|------|---------------|
| On-Call Engineer | First response, initial triage |
| Tech Lead | Architecture decisions, rollback approval |
| DevOps | Infrastructure, deployment issues |
| Database Admin | Supabase issues, schema problems |

---

## Post-Migration Validation

After all sprints complete:

1. **Performance Validation**
   - Booking response time < 200ms
   - Credit validation < 100ms
   - Concurrent user test (1000+ users)

2. **Data Validation**
   - Compare Supabase vs HubSpot credit values
   - Verify all bookings synced to HubSpot
   - Check association integrity

3. **Monitoring Setup**
   - Vercel cron monitoring active
   - Alert thresholds configured
   - Admin dashboard functional

4. **Documentation Update**
   - CLAUDE.md updated with new architecture
   - API documentation updated
   - Runbooks created for common issues

---

*Previous: [05-frontend-changes.md](./05-frontend-changes.md)*
*Back to: [00-overview.md](./00-overview.md)*
